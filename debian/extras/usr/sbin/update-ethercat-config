#!/bin/sh

#------------------------------------------------------------------------------

MODCONF=/etc/modprobe.d/ethercat.conf
MODLOAD=/etc/modules-load.d/ethercat.conf
IFACES=/etc/network/interfaces.d/ethercat

#------------------------------------------------------------------------------

ETHERCAT_CONFIG=/etc/default/ethercat

MODPROBE_FLAGS=""

if [ ! -r ${ETHERCAT_CONFIG} ]; then
    echo "${ETHERCAT_CONFIG} not existing"
    exit 6
fi

. ${ETHERCAT_CONFIG}

#------------------------------------------------------------------------------

exit_success() {
    echo "done."
    exit 0
}

#------------------------------------------------------------------------------

exit_fail() {
    echo "failed!"
    exit 1
}

#------------------------------------------------------------------------------

parse_mac_address() {
    if [ -z "${1}" ]; then
        MAC=""
        IFACE=""
    elif echo ${1} | grep -qE '^([0-9a-fA-F]{2}:){5}[0-9a-fA-F]{2}$'; then
        MAC=$(echo ${1} | tr [A-F] [a-f])
        IFACE=""
        for FN in $(find /sys/class/net -mindepth 1 -maxdepth 1); do
            if [ "$(cat ${FN}/address | tr [A-F] [a-f])" = "${MAC}" ]; then
                IFACE=$(basename $FN)
                break;
            fi
        done
    else
        echo "Invalid MAC address \"${1}\" in ${ETHERCAT_CONFIG}"
        exit_fail
    fi 
}

#------------------------------------------------------------------------------

add_interface() {
    if [ -n "${1}" ]; then
        echo "" >> ${IFACES}
        echo "allow-hotplug ${1}" >> ${IFACES}
        echo "iface ${1} inet manual" >> ${IFACES}
        echo "pre-up sysctl net.ipv6.conf.${1}.disable_ipv6=1" >> ${IFACES}
    fi
}

#------------------------------------------------------------------------------

echo "Updating EtherCAT master confiuration"

# check if master is loaded
MASTER_LOADED=""
grep -q '^ec_master ' /proc/modules && MASTER_LOADED="y"

# unload ethercat network drivers
for ECMODULE in `grep '^ec_' /proc/modules | grep -v '^ec_master ' | cut -d ' ' -f 1`; do
    rmmod ${ECMODULE} || exit_fail
done

# unload master, if loaded
if [ -n "${MASTER_LOADED}" ]; then
    rmmod ec_master || exit_fail
fi

# write config headers
rm -f ${MODCONF}
echo "# !! DO NOT EDIT THIS FILE !!" >> ${MODCONF}
echo "# please use update-ethercat-config" >> ${MODCONF}
echo "#" >> ${MODCONF}

rm -f ${IFACES}
echo "# !! DO NOT EDIT THIS FILE !!" >> ${IFACES}
echo "# please use update-ethercat-config" >> ${IFACES}
echo "#" >> ${IFACES}

# cleanup modules list
echo "ec_master" >${MODLOAD}.tmp

# check for modules to replace
for MODULE in ${DEVICE_MODULES}; do
    ECMODULE=ec_${MODULE}
    if ! modinfo ${ECMODULE} > /dev/null; then
        continue # ec_* module not found
    fi

    if [ "${MODULE}" != "generic" ] ; then
        # blacklist normal driver
        echo "blacklist ${MODULE}" >> ${MODCONF}

        # unload normal driver, if loaded
        if grep -q "^${MODULE} " /proc/modules; then
            rmmod ${MODULE} || exit_fail
        fi
    fi

    # add ethercat driver
    echo "${ECMODULE}" >>${MODLOAD}.tmp
done

# construct DEVICES and BACKUPS from configuration variables
DEVICES=""
BACKUPS=""
MASTER_INDEX=0
while true; do
    DEVICE=$(eval echo "\${MASTER${MASTER_INDEX}_DEVICE}")
    BACKUP=$(eval echo "\${MASTER${MASTER_INDEX}_BACKUP}")
    if [ -z "${DEVICE}" ]; then break; fi

    if [ ${MASTER_INDEX} -gt 0 ]; then
        DEVICES=${DEVICES},
        BACKUPS=${BACKUPS},
    fi

    parse_mac_address ${DEVICE}
    DEVICES=${DEVICES}${MAC}
    add_interface ${IFACE}
        
    parse_mac_address ${BACKUP}
    BACKUPS=${BACKUPS}${MAC}
    add_interface ${IFACE}

    MASTER_INDEX=$(expr ${MASTER_INDEX} + 1)
done

# configure master module
echo "options ec_master main_devices=${DEVICES} backup_devices=${BACKUPS}" >> ${MODCONF}

# reload master and network drivers
if [ -n "${MASTER_LOADED}" ]; then
    for MODULE in `grep '^ec_' ${MODLOAD}.tmp`; do
        modprobe ${MODPROBE_FLAGS} ${MODULE} || exit_fail
    done
fi

# set module list productive
mv ${MODLOAD}.tmp ${MODLOAD}

# update initramfs
update-initramfs -u

exit_success

#------------------------------------------------------------------------------
